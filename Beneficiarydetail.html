<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<base target="_top">

<title>Beneficiary Entry</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --primary:#1f4e79;
  --secondary:#2563eb;
  --accent:#0ea5e9;
  --card:#ffffff;
  --border:#c7d2fe;
}
body{
  font-family:"Segoe UI", Arial;
  background:linear-gradient(120deg,#e0ecff,#f6f9ff);
  min-height:100vh;
  margin:0;
  padding:0;
}
.box{
  max-width:540px;
  margin:50px auto;
  background:var(--card);
  padding:26px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.12);
  position:relative;
}
.box::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:6px;
  background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));
}
h2{
  text-align:center;
  color:var(--primary);
  margin-bottom:22px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  font-size:22px;
}
label{
  font-size:13px;
  color:#334155;
  font-weight:600;
  margin-top:12px;
  display:block;
}
select,input{
  width:100%;
  padding:11px;
  margin:6px 0;
  border-radius:9px;
  border:1px solid var(--border);
  background:#f9fbff;
  font-size:14px;
}
select:focus,input:focus{
  outline:none;
  border-color:var(--secondary);
  box-shadow:0 0 0 2px rgba(37,99,235,.15);
}
button{
  width:100%;
  padding:12px;
  margin-top:16px;
  border-radius:10px;
  background:var(--secondary);
  color:#fff;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
  border:none;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  box-shadow:0 6px 14px rgba(37,99,235,.35);
}
button:hover{
  background:#1d4ed8;
}
.success{
  margin-top:14px;
  font-size:14px;
  font-weight:600;
  text-align:center;
  color:#065f46;
  background:#ecfdf5;
  border:1px solid #bbf7d0;
  padding:8px;
  border-radius:8px;
}
.footer-note{
  margin-top:18px;
  font-size:12px;
  text-align:center;
  color:#64748b;
}
</style>
</head>

<body>
<div class="box">

<h2>
  <i class="fa-solid fa-people-group"></i>
  Upload Beneficiary Details
</h2>

<!-- SEARCH (works for both desktop & mobile) -->
<label><i class="fa-solid fa-magnifying-glass"></i> Search Work</label>
<input type="text" id="workSearch" placeholder="Type to filter work list">

<!-- DESKTOP: datalist input -->
<label><i class="fa-solid fa-list-check"></i> Select Work</label>
<input list="workList" id="workName" placeholder="Select work">
<datalist id="workList"></datalist>

<!-- MOBILE: native dropdown (hidden on desktop) -->
<select id="workSelect" style="display:none;">
  <option value="">Select work</option>
</select>

<label><i class="fa-solid fa-id-card"></i> Beneficiary ID Type</label>
<select id="beneficiaryType">
  <option>Ration Card</option>
  <option>Bhamashah / Janaadhar</option>
</select>

<label><i class="fa-solid fa-hashtag"></i> ID Number</label>
<input type="text" id="idNumber">

<label><i class="fa-solid fa-user"></i> Beneficiary Name</label>
<input type="text" id="beneficiaryName">

<label><i class="fa-solid fa-layer-group"></i> Category</label>
<select id="category">
  <option>SC</option>
  <option>ST</option>
  <option>OBC</option>
  <option>General</option>
  <option>Other</option>
</select>

<label><i class="fa-solid fa-image"></i> ID Photo ‚Äì Front Side</label>
<input type="file" accept="image/*" capture="environment" onchange="readFront(this)">

<label><i class="fa-solid fa-image"></i> ID Photo ‚Äì Back Side</label>
<input type="file" accept="image/*" capture="environment" onchange="readBack(this)">

<label><i class="fa-solid fa-file-pdf"></i> Upload Document (PDF if any)</label>
<input type="file" accept="application/pdf" onchange="readPdf(this)">

<button id="saveBtn" onclick="submitForm()">
  <i class="fa-solid fa-cloud-arrow-up"></i>
  Save Entry
</button>

<div class="success" id="msg"></div>

<div class="footer-note">
üå± e-WorkMS üå± Developed By - üë∑‚Äç‚ôÇÔ∏è Er. Aman Godara, AEn, WDSC, GoR
</div>

</div>

<script>
let frontPhoto=null, backPhoto=null, pdfFile=null;
let usedBeneficiaries=[];
let allWorks=[];

const workSearch=document.getElementById("workSearch");
const workList=document.getElementById("workList");
const workInput=document.getElementById("workName");
const workSelect=document.getElementById("workSelect");

/* LOAD WORK LIST */
google.script.run.withSuccessHandler(function(list){
  allWorks=[];
  workList.innerHTML="";
  workSelect.innerHTML='<option value="">Select work</option>';

  list.forEach(w=>{
    if(!w) return;
    allWorks.push(w);

    const opt=document.createElement("option");
    opt.value=w;
    workList.appendChild(opt);

    const opt2=document.createElement("option");
    opt2.value=w;
    opt2.textContent=w;
    workSelect.appendChild(opt2);
  });
}).getWorkListBeneficiaries();

/* SEARCH FILTER */
workSearch.addEventListener("input",()=>{
  const q=workSearch.value.toLowerCase();

  workList.innerHTML="";
  workSelect.innerHTML='<option value="">Select work</option>';

  allWorks
    .filter(w=>w.toLowerCase().includes(q))
    .forEach(w=>{
      const o1=document.createElement("option");
      o1.value=w;
      workList.appendChild(o1);

      const o2=document.createElement("option");
      o2.value=w;
      o2.textContent=w;
      workSelect.appendChild(o2);
    });
});

/* MOBILE FIX: use native select */
(function(){
  const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(!isMobile) return;

  workInput.style.display="none";
  workList.style.display="none";
  workSelect.style.display="block";

  workSelect.addEventListener("change",()=>{
    workInput.value=workSelect.value; // backend unchanged
  });
})();

/* already uploaded */
google.script.run.withSuccessHandler(l=>usedBeneficiaries=l)
  .getUploadedBeneficiaries();

/* file readers */
function readFront(i){
  if(!i.files[0])return;
  const r=new FileReader();
  r.onload=e=>frontPhoto=e.target.result.split(",")[1];
  r.readAsDataURL(i.files[0]);
}
function readBack(i){
  if(!i.files[0])return;
  const r=new FileReader();
  r.onload=e=>backPhoto=e.target.result.split(",")[1];
  r.readAsDataURL(i.files[0]);
}
function readPdf(i){
  if(!i.files[0])return;
  const r=new FileReader();
  r.onload=e=>pdfFile=e.target.result.split(",")[1];
  r.readAsDataURL(i.files[0]);
}

/* submit (UNCHANGED) */
function submitForm(){
  if(!workInput.value||!idNumber.value){
    alert("Work Name & ID Number required");
    return;
  }
  const key=beneficiaryType.value+"|"+idNumber.value;
  if(usedBeneficiaries.includes(key)){
    alert("Already uploaded");
    return;
  }
  msg.innerText="Uploading‚Ä¶";

  google.script.run
    .withSuccessHandler(res=>{
      if(res&&res.status==="SUCCESS"){
        msg.innerText="‚úî Entry Saved Successfully";
        usedBeneficiaries.push(key);
        workSearch.value="";
        workInput.value="";
        workSelect.value="";
        idNumber.value="";
        beneficiaryName.value="";
        frontPhoto=backPhoto=pdfFile=null;
      }else msg.innerText="‚ùå Failed";
    })
    .withFailureHandler(()=>{
      alert("Server error");
      msg.innerText="";
    })
    .uploadAndSaveBeneficiary({
      workName:workInput.value,
      beneficiaryType:beneficiaryType.value,
      idNumber:idNumber.value,
      beneficiaryName:beneficiaryName.value,
      category:category.value
    },frontPhoto,backPhoto,pdfFile);
}
</script>
</body>
</html>
