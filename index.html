<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<base target="_top">

<title>Beneficiary Entry</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --primary:#1f4e79;
  --secondary:#2563eb;
  --accent:#0ea5e9;
  --card:#ffffff;
  --border:#c7d2fe;
}
body{
  font-family:"Segoe UI", Arial;
  background:linear-gradient(120deg,#e0ecff,#f6f9ff);
  min-height:100vh;
  margin:0;
  padding:0;
}
.box{
  max-width:540px;
  margin:50px auto;
  background:var(--card);
  padding:26px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.12);
  position:relative;
}
.box::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:6px;
  background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));
}
h2{
  text-align:center;
  color:var(--primary);
  margin-bottom:22px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  font-size:22px;
}
label{
  font-size:13px;
  color:#334155;
  font-weight:600;
  margin-top:12px;
  display:block;
}
select,input{
  width:100%;
  padding:11px;
  margin:6px 0;
  border-radius:9px;
  border:1px solid var(--border);
  background:#f9fbff;
  font-size:14px;
}
button{
  width:100%;
  padding:12px;
  margin-top:16px;
  border-radius:10px;
  background:var(--secondary);
  color:#fff;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
  border:none;
}
.success{
  margin-top:14px;
  font-size:14px;
  font-weight:600;
  text-align:center;
  color:#065f46;
  background:#ecfdf5;
  border:1px solid #bbf7d0;
  padding:8px;
  border-radius:8px;
}
.footer-note{
  margin-top:18px;
  font-size:12px;
  text-align:center;
  color:#64748b;
}
</style>
</head>

<body>
<div class="box">

<h2><i class="fa-solid fa-people-group"></i> Upload Beneficiary Details</h2>

<label><i class="fa-solid fa-magnifying-glass"></i> Search Work</label>
<input type="text" id="workSearch" placeholder="Type to filter work list">

<label><i class="fa-solid fa-list-check"></i> Select Work</label>
<input list="workList" id="workName" placeholder="Select work">
<datalist id="workList"></datalist>

<select id="workSelect" style="display:none;"></select>

<label>Beneficiary ID Type</label>
<select id="beneficiaryType">
  <option>Ration Card</option>
  <option>Bhamashah / Janaadhar</option>
</select>

<label>ID Number</label>
<input type="text" id="idNumber">

<label>Beneficiary Name</label>
<input type="text" id="beneficiaryName">

<label>Category</label>
<select id="category">
  <option>SC</option>
  <option>ST</option>
  <option>OBC</option>
  <option>General</option>
  <option>Other</option>
</select>

<label>ID Photo ‚Äì Front Side</label>
<input type="file" accept="image/*" onchange="readFront(this)">

<label>ID Photo ‚Äì Back Side</label>
<input type="file" accept="image/*" onchange="readBack(this)">

<label>Upload Document (PDF if any)</label>
<input type="file" accept="application/pdf" onchange="readPdf(this)">

<button onclick="submitForm()">Save Entry</button>
<div class="success" id="msg"></div>

<div class="footer-note">
üå± e-WorkMS üå± Developed By ‚Äì üë∑‚Äç‚ôÇÔ∏è Er. Aman Godara
</div>

</div>

<script>
/* üîó BASE APPS SCRIPT URL (no /exec duplication) */
const API_URL =
  "https://script.google.com/macros/s/AKfycbySfRHPqB5sY_N4QeLyfXffGaHJQcpT-2iHU03wapC6fpSKTt5AQWthe7ArdQr-DReZgQ/exec";

let frontPhoto=null, backPhoto=null, pdfFile=null;
let allWorks=[], usedBeneficiaries=[];

const workList=document.getElementById("workList");
const workSelect=document.getElementById("workSelect");
const workSearch=document.getElementById("workSearch");

/* üì• LOAD WORK LIST (FIXED) */
fetch(API_URL+"?api=1&action=getWorks")
.then(r=>r.json())
.then(list=>{
  allWorks = Array.isArray(list) ? list : [];
  renderWorks(allWorks);
});

/* üì• LOAD USED BENEFICIARIES (FIXED NAME) */
fetch(API_URL+"?api=1&action=getUploaded")
.then(r=>r.json())
.then(d=>{
  usedBeneficiaries = Array.isArray(d) ? d : [];
});

function renderWorks(arr){
  workList.innerHTML="";
  workSelect.innerHTML='<option value="">Select work</option>';
  arr.forEach(w=>{
    const o=document.createElement("option");
    o.value=w;
    workList.appendChild(o);

    const s=document.createElement("option");
    s.value=w;
    s.textContent=w;
    workSelect.appendChild(s);
  });
}

/* üîç SEARCH FILTER */
workSearch.oninput=()=>{
  const q=workSearch.value.toLowerCase();
  renderWorks(allWorks.filter(w=>w.toLowerCase().includes(q)));
};

/* üì± MOBILE DROPDOWN FIX */
if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
  workSelect.style.display="block";
  workList.style.display="none";
  workSelect.onchange=()=>workName.value=workSelect.value;
}

/* FILE READERS */
function readFront(i){readFile(i,f=>frontPhoto=f);}
function readBack(i){readFile(i,f=>backPhoto=f);}
function readPdf(i){readFile(i,f=>pdfFile=f);}
function readFile(i,cb){
  if(!i.files[0])return;
  const r=new FileReader();
  r.onload=e=>cb(e.target.result.split(",")[1]);
  r.readAsDataURL(i.files[0]);
}

/* üöÄ SUBMIT */
function submitForm(){
  if(!workName.value||!idNumber.value){
    alert("Required fields missing");
    return;
  }

  const key = beneficiaryType.value+"|"+idNumber.value;
  if(usedBeneficiaries.includes(key)){
    alert("This beneficiary is already uploaded");
    return;
  }

  msg.innerText="Uploading‚Ä¶";

  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      workName:workName.value,
      beneficiaryType:beneficiaryType.value,
      idNumber:idNumber.value,
      beneficiaryName:beneficiaryName.value,
      category:category.value,
      frontPhotoBase64:frontPhoto,
      backPhotoBase64:backPhoto,
      pdfBase64:pdfFile
    })
  })
  .then(r=>r.json())
  .then(res=>{
    msg.innerText =
      res && res.status==="SUCCESS"
      ? "‚úî Entry Saved Successfully"
      : "‚ùå " + (res.message || "Failed");
  })
  .catch(()=>{
    msg.innerText="‚ùå Server error";
  });
}
</script>
</body>
</html>
